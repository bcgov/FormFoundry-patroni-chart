{{- range $i, $pod := list "0" "1" "2" }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ printf "%s-wal-cleanup-patroni-%s" (include "patroni.fullname" $) $pod }}
spec:
  schedule: {{ $.Values.walCleanup.schedule | quote }}
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: {{ include "patroni.serviceAccountName" $ }}
          containers:
            - name: wal-cleaner
              image: bitnami/kubectl:latest
              imagePullPolicy: Always
              command:
                - /bin/sh
                - -c
                - |
                  echo "[WAL CLEANUP] $(date)";
                  # Keep only the 2 newest WAL segments and 2 newest history files
                  kubectl exec {{ printf "%s-%s" (include "patroni.fullname" $) $pod }} -- /bin/sh -c '\
                    find /home/postgres/pgdata/pgroot/data/pg_wal -maxdepth 1 -type f -name "000000*" ! -name "*.history" 2>/dev/null | tail -n +3; \
                    find /home/postgres/pgdata/pgroot/data/pg_wal -maxdepth 1 -type f -name "*.history"      2>/dev/null | tail -n +3; \
                  ' | xargs -r rm -f;
          restartPolicy: OnFailure
{{- end }}
